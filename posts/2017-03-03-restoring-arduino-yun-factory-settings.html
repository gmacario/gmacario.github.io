<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Gianpaolo Macario&#x27;s public rants"/><title>Restoring Arduino Yun factory settings</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/80a777691809634caa52.css" as="style"/><link rel="stylesheet" href="/_next/static/css/80a777691809634caa52.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.1a5e6c0bcaecf178eee2.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.a817edd9b2693fcc6af8.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-daaff4f95c13923f49a5.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-2c0be973e770f89815b4.js" as="script"/><link rel="preload" href="/_next/static/chunks/b38cc82cec06c0ea8b096def674947a423bb2764.260eb1ac110a53311620.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-1c9a30b06d2f3be2ac9c.js" as="script"/></head><body><div id="__next"><main class="h-screen flex flex-col"><header class="py-3 fixed top-0 z-50 flex flex-wrap justify-between w-screen bg-white border-b border-gray-200"><div class="mx-3 py-2 px-4  font-bold text-indigo-500">Gianpaolo Macario&#x27;s blog</div><div class="justify-end"><a class="mr-6 py-2 px-4 inline-block rounded h-full text-indigo-500 hover:text-white hover:bg-indigo-500" href="/">Home</a><a class="mr-6 py-2 px-4 inline-block rounded h-full text-indigo-500 hover:text-white hover:bg-indigo-500" href="/posts">Posts</a></div></header><div class="pt-28 mx-auto w-5/6 break-words flex flex-grow prose prose-indigo hover:prose-black md:prose-lg lg:prose-xl"><article><h1>Restoring Arduino Yun factory settings</h1><div class="prose prose-indigo hover:prose-black md:prose-lg lg:prose-xl"><!-- markdown-link-check-disable -->

<h3 id="the-problem">The problem</h3>
<p>After a few months of uninterrupted service, my <a href="https://www.arduino.cc/en/Main/ArduinoBoardYun">Arduino Yun</a> started rebooting every couple of minutes.</p>
<p>Debugging by connecting the Arduino Yun to my laptop via USB cable.</p>
<p>Run a terminal emulator (i.e. PuTTY) COMx:57600,8,n,1</p>
<p>Login as <code>root</code></p>
<pre><code>root@ardyungm33:/# mount
rootfs on / type rootfs (rw)
/dev/root on /rom type squashfs (ro,relatime)
proc on /proc type proc (rw,noatime)
sysfs on /sys type sysfs (rw,noatime)
tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime,size=30560k)
tmpfs on /dev type tmpfs (rw,noatime,size=512k,mode=755)
devpts on /dev/pts type devpts (rw,noatime,mode=600)
/dev/mtdblock3 on /overlay type jffs2 (rw,noatime)
overlayfs:/overlay on / type overlayfs (rw,relatime,lowerdir=/,upperdir=/overlay)
debugfs on /sys/kernel/debug type debugfs (rw,relatime)
root@ardyungm33:/#
</code></pre>
<p><code>/dev/mtd3</code> is the raw image of overlay</p>
<pre><code>root@ardyungm33:/# cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00040000 00010000 &quot;u-boot&quot;
mtd1: 00010000 00010000 &quot;u-boot-env&quot;
mtd2: 00e50000 00010000 &quot;rootfs&quot;
mtd3: 006f0000 00010000 &quot;rootfs_data&quot;
mtd4: 00140000 00010000 &quot;kernel&quot;
mtd5: 00010000 00010000 &quot;nvram&quot;
mtd6: 00010000 00010000 &quot;art&quot;
mtd7: 00f90000 00010000 &quot;firmware&quot;
root@ardyungm33:/#
</code></pre>
<p>After less than one minute from boot the board will restart - most likely because r/w overlay at <code>/dev/mtd3block</code> (rootfs_data) is corrupted.</p>
<pre><code>root@ardyungm33:/#
root@ardyungm33:/# ping Jan 14 05:24:35 tinc.ninuxto[1107]: Got TERM signal
Jan 14 05:24:35 tinc.ninuxto[1107]: Terminating
10[  129.650000] Removing MTD device #3 (rootfs_data) with use count 1
[  129.670000] Res▒

U-Boot 1.1.4-dirty (Apr 10 2014 - 15:12:15)

Arduino Yun (ar9331) U-boot
...
</code></pre>
<p>Notice the error message <code>  129.650000] Removing MTD device #3 (rootfs_data) with use count 1</code></p>
<h3 id="try-failsafe-mode">Try Failsafe mode</h3>
<p>Just after the Yun reboots, press <code>ENTER</code> to stop at U-boot prompt.</p>
<pre><code>root@ardyungm33:/#
root@ardyungm33:/# ping Jan 14 05:24:35 tinc.ninuxto[1107]: Got TERM signal
Jan 14 05:24:35 tinc.ninuxto[1107]: Terminating
10[  129.650000] Removing MTD device #3 (rootfs_data) with use count 1
[  129.670000] Res▒

U-Boot 1.1.4-dirty (Apr 10 2014 - 15:12:15)

Arduino Yun (ar9331) U-boot

DRAM:  64 MB
Top of RAM usable for U-Boot at: 84000000
Reserving 142k for U-Boot at: 83fdc000
Reserving 192k for malloc() at: 83fac000
Reserving 44 Bytes for Board Info at: 83fabfd4
Reserving 36 Bytes for Global Data at: 83fabfb0
Reserving 128k for boot params() at: 83f8bfb0
Stack Pointer at: 83f8bf98
Now running in RAM - U-Boot at: 83fdc000
Flash Manuf Id 0xef, DeviceId0 0x40, DeviceId1 0x18
flash size 16777216, sector count = 256
Flash: 16 MB
Using default environment

In:    serial
Out:   serial
Err:   serial
Net:   ag7240_enet_initialize...
No valid address in Flash. Using fixed address
No valid address in Flash. Using fixed address
: cfg1 0x5 cfg2 0x7114
eth0: 00:03:7f:09:0b:ad
eth0 up
: cfg1 0xf cfg2 0x7214
eth1: 00:03:7f:09:0b:ad
athrs26_reg_init_lan
ATHRS26: resetting s26
ATHRS26: s26 reset done
eth1 up
eth0, eth1
Hit any key to stop autoboot:  0
ar7240&gt;
</code></pre>
<p>Type <code>boot</code> to boot Linux, then press <code>F</code> to enter failsafe mode</p>
<pre><code>ar7240&gt;
ar7240&gt; boot
## Booting image at 9fea0000 ...
   Image Name:   MIPS OpenWrt Linux-3.3.8
   Created:      2014-11-14   8:00:46 UTC
   Image Type:   MIPS Linux Kernel Image (lzma compressed)
   Data Size:    1185448 Bytes =  1.1 MB
   Load Address: 80060000
   Entry Point:  80060000
   Verifying Checksum at 0x9fea0040 ...OK
   Uncompressing Kernel Image ...
...
[    4.240000] scsi0 : usb-storage 1-1.4:1.0
[    5.020000] Error: Driver &#39;gpio-keys-polled&#39; is already registered, aborting...
[    5.240000] scsi 0:0:0:0: Direct-Access     Multi    Flash Reader     1.00 PQ: 0 ANSI: 0
- preinit -
Press the [f] key and hit [enter] to enter failsafe mode
f
- failsafe -
/etc/preinit: line 1: telnetd: not found


BusyBox v1.19.4 (2014-11-13 19:03:47 CET) built-in shell (ash)
Enter &#39;help&#39; for a list of built-in commands.

  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
-----------------------------------------------------


root@(none):/#
</code></pre>
<p>Inspect MTD partitions</p>
<pre><code>root@(none):/# cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00040000 00010000 &quot;u-boot&quot;
mtd1: 00010000 00010000 &quot;u-boot-env&quot;
mtd2: 00e50000 00010000 &quot;rootfs&quot;
mtd3: 006f0000 00010000 &quot;rootfs_data&quot;
mtd4: 00140000 00010000 &quot;kernel&quot;
mtd5: 00010000 00010000 &quot;nvram&quot;
mtd6: 00010000 00010000 &quot;art&quot;
mtd7: 00f90000 00010000 &quot;firmware&quot;
root@(none):/#
</code></pre>
<p>Inspect mounted filesystems</p>
<pre><code>root@(none):/# mount
rootfs on / type rootfs (rw)
/dev/root on / type squashfs (ro,relatime)
proc on /proc type proc (rw,noatime)
sysfs on /sys type sysfs (rw,noatime)
tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime,size=30560k)
tmpfs on /dev type tmpfs (rw,noatime,size=512k,mode=755)
devpts on /dev/pts type devpts (rw,noatime,mode=600)
root@(none):/#
</code></pre>
<p>OK, overlayfs was not mounted.</p>
<h3 id="try-zeroing-devmtd3">Try zeroing <code>/dev/mtd3</code></h3>
<!-- 2017-01-26 19:03 CET -->

<p>We are then safe to erase <code>/dev/mtd3</code></p>
<pre><code>root@(none):/# dd if=/dev/zero of=/dev/mtd3
root@(none):/#
</code></pre>
<p>Now exit and cycle power (must disconnect and reconnect USB cable)</p>
<pre><code>root@(none):/# exit
Please reboot system when done with failsafe network logins
</code></pre>
<h3 id="retry-boot-after-zeroing-devmtd3">Retry boot after zeroing <code>/dev/mtd3</code></h3>
<pre><code>...
[    4.240000] scsi0 : usb-storage 1-1.4:1.0
[    5.030000] Error: Driver &#39;gpio-keys-polled&#39; is already registered, aborting...
[    5.240000] scsi 0:0:0:0: Direct-Access     Multi    Flash Reader     1.00 PQ: 0 ANSI: 0
- preinit -
Press the [f] key and hit [enter] to enter failsafe mode
- regular preinit -
[   13.200000] Cowardly refusing to erase blocks on filesystem with no valid JFFS2 nodes
[   13.200000] empty_blocks 0, bad_blocks 0, c-&gt;nr_blocks 111
[   14.380000] sd 0:0:0:0: [sda] Attached SCSI removable disk
switching to jffs2
- init -
[   41.710000] Loading modules backported from Linux version master-2014-05-22-0-gf2032ea
...
</code></pre>
<p>TODO: Not sure whether zeroing <code>/dev/mtd3</code> is enough - need to look inside factory image (to be loaded via TFTP)</p>
<p>Notice that failsafe mode still works, though.</p>
<p>TODO: Understand how to properly format a JFFS2 partitions.</p>
<p>TODO: Read <a href="http://free-electrons.com/blog/managing-flash-storage-with-linux/">http://free-electrons.com/blog/managing-flash-storage-with-linux/</a></p>
<pre><code>[    4.240000] scsi0 : usb-storage 1-1.4:1.0
[    5.030000] Error: Driver &#39;gpio-keys-polled&#39; is already registered, aborting...
[    5.240000] scsi 0:0:0:0: Direct-Access     Multi    Flash Reader     1.00 PQ: 0 ANSI: 0
- preinit -
Press the [f] key and hit [enter] to enter failsafe mode
- regular preinit -
[   13.210000] Cowardly refusing to erase blocks on filesystem with no valid JFFS2 nodes
[   13.210000] empty_blocks 0, bad_blocks 0, c-&gt;nr_blocks 111
[   14.390000] sd 0:0:0:0: [sda] Attached SCSI removable disk
</code></pre>
<h3 id="reflash-the-openwrt-yun-image-on-the-yun">Reflash the OpenWrt-Yun image on the Yun</h3>
<!-- 2017-01-27 13:00 CET -->

<p>Follow instructions at <a href="https://www.arduino.cc/en/Tutorial/YunUBootReflash">https://www.arduino.cc/en/Tutorial/YunUBootReflash</a></p>
<p>This procedure uses U-Boot to load kernel and openwrt-rootfs via TFTP</p>
<p>Download the <a href="http://arduino.cc/download_handler.php?f=/openwrtyun/1/YunImage_v1.5.3.zip">base images</a> zip file.</p>
<p>Setup a TFTP server on kruk (Ubuntu 16.04 LTS)</p>
<p>Logged as user@kruk</p>
<pre><code>sudo apt update
sudo apt install tftpd-hpa
</code></pre>
<p>When asked for the directory to use as root for the TFTP server, leave the default value <code>/var/lib/tftpboot</code>.</p>
<p>Unzip <code>~/Downloads/YunImage_v1.5.3.zip</code> into folder <code>/var/lib/tftpboot</code>:</p>
<pre><code>cd /var/lib/tftpboot
sudo unzip ~/Downloads/YunImage_v1.5.3.zip
</code></pre>
<p>Power up the Yun and type a key to stop at the U-Boot prompt.</p>
<p>At the U-Boot prompt</p>
<pre><code>setenv serverip 192.168.12.20;
setenv ipaddr 192.168.12.201;
</code></pre>
<h4 id="reflashing-kernel">Reflashing Kernel</h4>
<!-- 2017-01-27 12:24 CET -->

<p>Download the file via FTP</p>
<pre><code>tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-kernel.bin;
</code></pre>
<p>Erase partition and copy the downloaded image</p>
<pre><code>erase 0x9fEa0000 +0x140000;
cp.b $fileaddr 0x9fea0000 $filesize;
</code></pre>
<p>Result:</p>
<pre><code>ar7240&gt; setenv serverip 192.168.12.20;
ar7240&gt; setenv ipaddr 192.168.12.201;
ar7240&gt; tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-kernel.bin;
dup 1 speed 100
Using eth0 device
TFTP from server 192.168.12.20; our IP address is 192.168.12.201
Filename &#39;openwrt-ar71xx-generic-yun-16M-kernel.bin&#39;.
Load address: 0x80060000
Loading: #################################################################
         #################################################################
         #################################################################
         #################################################
done
Bytes transferred = 1245184 (130000 hex)
ar7240&gt; erase 0x9fEa0000 +0x140000;
Erase Flash from 0x9fea0000 to 0x9ffdffff in Bank # 1
First 0xea last 0xfd sector size 0x10000                                     253
Erased 20 sectors
ar7240&gt; cp.b $fileaddr 0x9fea0000 $filesize;
Copy to Flash... write addr: 9fea0000
done
ar7240&gt;
</code></pre>
<h4 id="reflashing-openwrt-yun">Reflashing OpenWrt-Yun</h4>
<!-- 2017-01-27 12:31 CET -->

<p>Download the file via FTP</p>
<pre><code>tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-rootfs-squashfs.bin;
</code></pre>
<p>Erase partition and copy the downloaded image</p>
<pre><code>erase 0x9f050000 +0xE50000;
cp.b $fileaddr 0x9f050000 $filesize;
</code></pre>
<p>Result:</p>
<pre><code>ar7240&gt; tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-rootfs-squashfs.bin;
Using eth0 device
TFTP from server 192.168.12.20; our IP address is 192.168.12.201
Filename &#39;openwrt-ar71xx-generic-yun-16M-rootfs-squashfs.bin&#39;.
Load address: 0x80060000
Loading: #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         ##########################################
done
Bytes transferred = 7864320 (780000 hex)
ar7240&gt; erase 0x9f050000 +0xE50000;
Erase Flash from 0x9f050000 to 0x9fe9ffff in Bank # 1
First 0x5 last 0xe9 sector size 0x10000                                      233
Erased 229 sectors
ar7240&gt;  cp.b $fileaddr 0x9f050000 $filesize;
Copy to Flash... write addr: 9f050000
done
ar7240&gt;
</code></pre>
<h4 id="rebooting">Rebooting</h4>
<!-- 2017-01-27 12:34 CET -->

<pre><code>bootm 0x9fea0000
</code></pre>
<p>Press &quot;Enter&quot; for console login</p>
<p>Result:</p>
<pre><code>...
[   40.550000] Linux video capture interface: v2.00
[   40.670000] fuse init (API version 7.18)
[   47.910000] eth1: link up (100Mbps/Full duplex)



BusyBox v1.19.4 (2014-11-13 19:03:47 CET) built-in shell (ash)
Enter &#39;help&#39; for a list of built-in commands.

  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 -----------------------------------------------------


root@Arduino:/#
</code></pre>
<p>Inspect filesystem usage after factory reflash</p>
<pre><code>root@Arduino:/# df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                    6.9M    356.0K      6.6M   5% /
/dev/root                 7.5M      7.5M         0 100% /rom
tmpfs                    29.8M    100.0K     29.7M   0% /tmp
tmpfs                   512.0K         0    512.0K   0% /dev
/dev/mtdblock3            6.9M    356.0K      6.6M   5% /overlay
overlayfs:/overlay        6.9M    356.0K      6.6M   5% /
root@Arduino:/#
</code></pre>
<p>Check <code>/proc/cmdline</code></p>
<pre><code>root@Arduino:/# cat /proc/cmdline
 board=Yun console=ttyATH0,250000 mtdparts=spi0.0:256k(u-boot)ro,64k(u-boot-env)ro,14656k(rootfs),1280k(kernel),64k(nvram),64k(art),15936k@0x50000(firmware) rootfstype=squashfs,jffs2 noinitrd
root@Arduino:/#
</code></pre>
<p>Check installed openwrt-yun-release</p>
<pre><code>root@Arduino:~# cat /etc/arduino/openwrt-yun-release
built=Fri Nov 14 03:53:51 CET 2014
root@Arduino:~#
</code></pre>
<hr>
<h3 id="alternative-nuke-overlay">Alternative: Nuke <code>/overlay</code></h3>
<!-- 2017-03-03 16:32 -->

<p>Boot <code>ardyungm33</code> in failsafe mode by pressing the <code>F</code> and ENTER keys.</p>
<pre><code>root@(none):/# df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                    7.5M      7.5M         0 100% /
/dev/root                 7.5M      7.5M         0 100% /
tmpfs                    29.8M     12.0K     29.8M   0% /tmp
tmpfs                   512.0K         0    512.0K   0% /dev
root@(none):/#
</code></pre>
<p>Execute <code>mount_root</code> (checked from TODO to TODO)</p>
<pre><code>root@(none):/# mount_root
[  863.240000] JFFS2 notice: (533) jffs2_build_xattr_subsystem: complete building xattr subsystem, 1 of xdatum (1 unchecked, 0 orphan) and 12 of xref (0 dead, 1 orphan) found.
switching to jffs2
root@(none):/#
</code></pre>
<p>Apart the suspicious message, the <code>/overlay</code> is mounted</p>
<pre><code>root@(none):/# df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                    6.9M      1.6M      5.3M  23% /
/dev/root                 7.5M      7.5M         0 100% /rom
tmpfs                    29.8M     12.0K     29.8M   0% /tmp
tmpfs                   512.0K         0    512.0K   0% /dev
/dev/mtdblock3            6.9M      1.6M      5.3M  23% /overlay
overlayfs:/overlay        6.9M      1.6M      5.3M  23% /
root@(none):/#
</code></pre>
<p>Press &quot;YUN RST&quot; button, then enter failsafe mode.</p>
<p>Understand the <code>/sbin/firstboot</code> script:</p>
<pre><code>root@(none):/# which firstboot
/sbin/firstboot
root@(none):/# cat /sbin/firstboot
#!/bin/sh

switch2jffs_hook=
jffs2reset_hook=
no_fo_hook=

. /lib/functions/boot.sh

firstboot_skip_next=false

for fb_source_file in /lib/firstboot/*; do
    . $fb_source_file
done

set_mtd_part
set_rom_part
set_jffs_part

# invoked as an executable
if [ &quot;${0##*/}&quot; = &quot;firstboot&quot; ]; then
    if [ &quot;$1&quot; = &quot;switch2jffs&quot; ]; then
        boot_run_hook switch2jffs
    elif [ -n &quot;$jffs&quot; ]; then
        reset_has_fo=true
        echo &quot;firstboot has already been run&quot;
        echo &quot;jffs2 partition is mounted, only resetting files&quot;
        boot_run_hook jffs2reset
    else
        mtd erase &quot;$partname&quot;
        mount &quot;$mtdpart&quot; /overlay -t jffs2
        fopivot /overlay /rom 1
    fi
fi

root@(none):/#
</code></pre>
<!-- 2017-03-03 16:39 CET -->

<p>Execute the <code>/bin/firstboot</code> script:</p>
<pre><code>root@(none):/# /sbin/firstboot
[  133.510000] JFFS2 notice: (533) jffs2_build_xattr_subsystem: complete building xattr subsystem, 0 of xdatum (0 unchecked, 0 orphan) and 0 of xref (0 dead, 0 orphan) found.
root@(none):/#
</code></pre>
<p>==&gt; Much better now!!!</p>
<p>Press &quot;RST YUN&quot; then boot to regular mode (do not press &quot;F&quot;)</p>
<pre><code>[   40.630000] fuse init (API version 7.18)

Please press Enter to activate this console.


BusyBox v1.19.4 (2014-11-13 19:03:47 CET) built-in shell (ash)
Enter &#39;help&#39; for a list of built-in commands.

  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 -----------------------------------------------------


root@Arduino:/#
</code></pre>
<!-- markdown-link-check-enable -->
<!-- EOF -->
</div></article></div><footer class="h-auto mt-20 bg-gray-100 justify-between border-t border-gray-200"><div class="pt-6 mx-auto  gap-x-6 w-9/12 flex flex-col prose prose-indigo hover:prose-black md:prose-lg lg:prose-xl"><div class="prose-xl"><p class="">gmacario.github.io</p></div><div class="flex flex-col sm:flex-row flex-wrap justify-between md:justify-start"><p class="mr-12 text-gray-600 prose-sm">gmacario.github.io</p><div class="mr-12 flex flex-col justify-start"><p class="text-gray-600 prose-sm flex flex-row"><svg class="MuiSvgIcon-root mr-2" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .3a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1-.7.1-.7.1-.7 1.2 0 1.9 1.2 1.9 1.2 1 1.8 2.8 1.3 3.5 1 0-.8.4-1.3.7-1.6-2.7-.3-5.5-1.3-5.5-6 0-1.2.5-2.3 1.3-3.1-.2-.4-.6-1.6 0-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 0 1 6 0c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8 0 3.2.9.8 1.3 1.9 1.3 3.2 0 4.6-2.8 5.6-5.5 5.9.5.4.9 1 .9 2.2v3.3c0 .3.1.7.8.6A12 12 0 0 0 12 .3"></path></svg><a href="https://github.com/gmacario">gmacario</a></p><p class="text-gray-600 prose-sm flex flex-row"><svg class="MuiSvgIcon-root mr-2" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"></path></svg><a href="https://www.twitter.com/gpmacario">gpmacario</a></p></div><p class="mr-12 text-gray-600 prose-sm">Gianpaolo Macario&#x27;s public rants</p></div></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Restoring Arduino Yun factory settings","content":"\u003c!-- markdown-link-check-disable --\u003e\n\n\u003ch3 id=\"the-problem\"\u003eThe problem\u003c/h3\u003e\n\u003cp\u003eAfter a few months of uninterrupted service, my \u003ca href=\"https://www.arduino.cc/en/Main/ArduinoBoardYun\"\u003eArduino Yun\u003c/a\u003e started rebooting every couple of minutes.\u003c/p\u003e\n\u003cp\u003eDebugging by connecting the Arduino Yun to my laptop via USB cable.\u003c/p\u003e\n\u003cp\u003eRun a terminal emulator (i.e. PuTTY) COMx:57600,8,n,1\u003c/p\u003e\n\u003cp\u003eLogin as \u003ccode\u003eroot\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@ardyungm33:/# mount\nrootfs on / type rootfs (rw)\n/dev/root on /rom type squashfs (ro,relatime)\nproc on /proc type proc (rw,noatime)\nsysfs on /sys type sysfs (rw,noatime)\ntmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime,size=30560k)\ntmpfs on /dev type tmpfs (rw,noatime,size=512k,mode=755)\ndevpts on /dev/pts type devpts (rw,noatime,mode=600)\n/dev/mtdblock3 on /overlay type jffs2 (rw,noatime)\noverlayfs:/overlay on / type overlayfs (rw,relatime,lowerdir=/,upperdir=/overlay)\ndebugfs on /sys/kernel/debug type debugfs (rw,relatime)\nroot@ardyungm33:/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003e/dev/mtd3\u003c/code\u003e is the raw image of overlay\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@ardyungm33:/# cat /proc/mtd\ndev:    size   erasesize  name\nmtd0: 00040000 00010000 \u0026quot;u-boot\u0026quot;\nmtd1: 00010000 00010000 \u0026quot;u-boot-env\u0026quot;\nmtd2: 00e50000 00010000 \u0026quot;rootfs\u0026quot;\nmtd3: 006f0000 00010000 \u0026quot;rootfs_data\u0026quot;\nmtd4: 00140000 00010000 \u0026quot;kernel\u0026quot;\nmtd5: 00010000 00010000 \u0026quot;nvram\u0026quot;\nmtd6: 00010000 00010000 \u0026quot;art\u0026quot;\nmtd7: 00f90000 00010000 \u0026quot;firmware\u0026quot;\nroot@ardyungm33:/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAfter less than one minute from boot the board will restart - most likely because r/w overlay at \u003ccode\u003e/dev/mtd3block\u003c/code\u003e (rootfs_data) is corrupted.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@ardyungm33:/#\nroot@ardyungm33:/# ping Jan 14 05:24:35 tinc.ninuxto[1107]: Got TERM signal\nJan 14 05:24:35 tinc.ninuxto[1107]: Terminating\n10[  129.650000] Removing MTD device #3 (rootfs_data) with use count 1\n[  129.670000] Res▒\n\nU-Boot 1.1.4-dirty (Apr 10 2014 - 15:12:15)\n\nArduino Yun (ar9331) U-boot\n...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNotice the error message \u003ccode\u003e  129.650000] Removing MTD device #3 (rootfs_data) with use count 1\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"try-failsafe-mode\"\u003eTry Failsafe mode\u003c/h3\u003e\n\u003cp\u003eJust after the Yun reboots, press \u003ccode\u003eENTER\u003c/code\u003e to stop at U-boot prompt.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@ardyungm33:/#\nroot@ardyungm33:/# ping Jan 14 05:24:35 tinc.ninuxto[1107]: Got TERM signal\nJan 14 05:24:35 tinc.ninuxto[1107]: Terminating\n10[  129.650000] Removing MTD device #3 (rootfs_data) with use count 1\n[  129.670000] Res▒\n\nU-Boot 1.1.4-dirty (Apr 10 2014 - 15:12:15)\n\nArduino Yun (ar9331) U-boot\n\nDRAM:  64 MB\nTop of RAM usable for U-Boot at: 84000000\nReserving 142k for U-Boot at: 83fdc000\nReserving 192k for malloc() at: 83fac000\nReserving 44 Bytes for Board Info at: 83fabfd4\nReserving 36 Bytes for Global Data at: 83fabfb0\nReserving 128k for boot params() at: 83f8bfb0\nStack Pointer at: 83f8bf98\nNow running in RAM - U-Boot at: 83fdc000\nFlash Manuf Id 0xef, DeviceId0 0x40, DeviceId1 0x18\nflash size 16777216, sector count = 256\nFlash: 16 MB\nUsing default environment\n\nIn:    serial\nOut:   serial\nErr:   serial\nNet:   ag7240_enet_initialize...\nNo valid address in Flash. Using fixed address\nNo valid address in Flash. Using fixed address\n: cfg1 0x5 cfg2 0x7114\neth0: 00:03:7f:09:0b:ad\neth0 up\n: cfg1 0xf cfg2 0x7214\neth1: 00:03:7f:09:0b:ad\nathrs26_reg_init_lan\nATHRS26: resetting s26\nATHRS26: s26 reset done\neth1 up\neth0, eth1\nHit any key to stop autoboot:  0\nar7240\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eType \u003ccode\u003eboot\u003c/code\u003e to boot Linux, then press \u003ccode\u003eF\u003c/code\u003e to enter failsafe mode\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ear7240\u0026gt;\nar7240\u0026gt; boot\n## Booting image at 9fea0000 ...\n   Image Name:   MIPS OpenWrt Linux-3.3.8\n   Created:      2014-11-14   8:00:46 UTC\n   Image Type:   MIPS Linux Kernel Image (lzma compressed)\n   Data Size:    1185448 Bytes =  1.1 MB\n   Load Address: 80060000\n   Entry Point:  80060000\n   Verifying Checksum at 0x9fea0040 ...OK\n   Uncompressing Kernel Image ...\n...\n[    4.240000] scsi0 : usb-storage 1-1.4:1.0\n[    5.020000] Error: Driver \u0026#39;gpio-keys-polled\u0026#39; is already registered, aborting...\n[    5.240000] scsi 0:0:0:0: Direct-Access     Multi    Flash Reader     1.00 PQ: 0 ANSI: 0\n- preinit -\nPress the [f] key and hit [enter] to enter failsafe mode\nf\n- failsafe -\n/etc/preinit: line 1: telnetd: not found\n\n\nBusyBox v1.19.4 (2014-11-13 19:03:47 CET) built-in shell (ash)\nEnter \u0026#39;help\u0026#39; for a list of built-in commands.\n\n  _______                     ________        __\n |       |.-----.-----.-----.|  |  |  |.----.|  |_\n |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|\n |_______||   __|_____|__|__||________||__|  |____|\n          |__| W I R E L E S S   F R E E D O M\n-----------------------------------------------------\n\n\nroot@(none):/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eInspect MTD partitions\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@(none):/# cat /proc/mtd\ndev:    size   erasesize  name\nmtd0: 00040000 00010000 \u0026quot;u-boot\u0026quot;\nmtd1: 00010000 00010000 \u0026quot;u-boot-env\u0026quot;\nmtd2: 00e50000 00010000 \u0026quot;rootfs\u0026quot;\nmtd3: 006f0000 00010000 \u0026quot;rootfs_data\u0026quot;\nmtd4: 00140000 00010000 \u0026quot;kernel\u0026quot;\nmtd5: 00010000 00010000 \u0026quot;nvram\u0026quot;\nmtd6: 00010000 00010000 \u0026quot;art\u0026quot;\nmtd7: 00f90000 00010000 \u0026quot;firmware\u0026quot;\nroot@(none):/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eInspect mounted filesystems\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@(none):/# mount\nrootfs on / type rootfs (rw)\n/dev/root on / type squashfs (ro,relatime)\nproc on /proc type proc (rw,noatime)\nsysfs on /sys type sysfs (rw,noatime)\ntmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime,size=30560k)\ntmpfs on /dev type tmpfs (rw,noatime,size=512k,mode=755)\ndevpts on /dev/pts type devpts (rw,noatime,mode=600)\nroot@(none):/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOK, overlayfs was not mounted.\u003c/p\u003e\n\u003ch3 id=\"try-zeroing-devmtd3\"\u003eTry zeroing \u003ccode\u003e/dev/mtd3\u003c/code\u003e\u003c/h3\u003e\n\u003c!-- 2017-01-26 19:03 CET --\u003e\n\n\u003cp\u003eWe are then safe to erase \u003ccode\u003e/dev/mtd3\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@(none):/# dd if=/dev/zero of=/dev/mtd3\nroot@(none):/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow exit and cycle power (must disconnect and reconnect USB cable)\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@(none):/# exit\nPlease reboot system when done with failsafe network logins\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"retry-boot-after-zeroing-devmtd3\"\u003eRetry boot after zeroing \u003ccode\u003e/dev/mtd3\u003c/code\u003e\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003e...\n[    4.240000] scsi0 : usb-storage 1-1.4:1.0\n[    5.030000] Error: Driver \u0026#39;gpio-keys-polled\u0026#39; is already registered, aborting...\n[    5.240000] scsi 0:0:0:0: Direct-Access     Multi    Flash Reader     1.00 PQ: 0 ANSI: 0\n- preinit -\nPress the [f] key and hit [enter] to enter failsafe mode\n- regular preinit -\n[   13.200000] Cowardly refusing to erase blocks on filesystem with no valid JFFS2 nodes\n[   13.200000] empty_blocks 0, bad_blocks 0, c-\u0026gt;nr_blocks 111\n[   14.380000] sd 0:0:0:0: [sda] Attached SCSI removable disk\nswitching to jffs2\n- init -\n[   41.710000] Loading modules backported from Linux version master-2014-05-22-0-gf2032ea\n...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTODO: Not sure whether zeroing \u003ccode\u003e/dev/mtd3\u003c/code\u003e is enough - need to look inside factory image (to be loaded via TFTP)\u003c/p\u003e\n\u003cp\u003eNotice that failsafe mode still works, though.\u003c/p\u003e\n\u003cp\u003eTODO: Understand how to properly format a JFFS2 partitions.\u003c/p\u003e\n\u003cp\u003eTODO: Read \u003ca href=\"http://free-electrons.com/blog/managing-flash-storage-with-linux/\"\u003ehttp://free-electrons.com/blog/managing-flash-storage-with-linux/\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[    4.240000] scsi0 : usb-storage 1-1.4:1.0\n[    5.030000] Error: Driver \u0026#39;gpio-keys-polled\u0026#39; is already registered, aborting...\n[    5.240000] scsi 0:0:0:0: Direct-Access     Multi    Flash Reader     1.00 PQ: 0 ANSI: 0\n- preinit -\nPress the [f] key and hit [enter] to enter failsafe mode\n- regular preinit -\n[   13.210000] Cowardly refusing to erase blocks on filesystem with no valid JFFS2 nodes\n[   13.210000] empty_blocks 0, bad_blocks 0, c-\u0026gt;nr_blocks 111\n[   14.390000] sd 0:0:0:0: [sda] Attached SCSI removable disk\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"reflash-the-openwrt-yun-image-on-the-yun\"\u003eReflash the OpenWrt-Yun image on the Yun\u003c/h3\u003e\n\u003c!-- 2017-01-27 13:00 CET --\u003e\n\n\u003cp\u003eFollow instructions at \u003ca href=\"https://www.arduino.cc/en/Tutorial/YunUBootReflash\"\u003ehttps://www.arduino.cc/en/Tutorial/YunUBootReflash\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThis procedure uses U-Boot to load kernel and openwrt-rootfs via TFTP\u003c/p\u003e\n\u003cp\u003eDownload the \u003ca href=\"http://arduino.cc/download_handler.php?f=/openwrtyun/1/YunImage_v1.5.3.zip\"\u003ebase images\u003c/a\u003e zip file.\u003c/p\u003e\n\u003cp\u003eSetup a TFTP server on kruk (Ubuntu 16.04 LTS)\u003c/p\u003e\n\u003cp\u003eLogged as user@kruk\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003esudo apt update\nsudo apt install tftpd-hpa\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhen asked for the directory to use as root for the TFTP server, leave the default value \u003ccode\u003e/var/lib/tftpboot\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eUnzip \u003ccode\u003e~/Downloads/YunImage_v1.5.3.zip\u003c/code\u003e into folder \u003ccode\u003e/var/lib/tftpboot\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ecd /var/lib/tftpboot\nsudo unzip ~/Downloads/YunImage_v1.5.3.zip\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePower up the Yun and type a key to stop at the U-Boot prompt.\u003c/p\u003e\n\u003cp\u003eAt the U-Boot prompt\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003esetenv serverip 192.168.12.20;\nsetenv ipaddr 192.168.12.201;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"reflashing-kernel\"\u003eReflashing Kernel\u003c/h4\u003e\n\u003c!-- 2017-01-27 12:24 CET --\u003e\n\n\u003cp\u003eDownload the file via FTP\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003etftp 0x80060000 openwrt-ar71xx-generic-yun-16M-kernel.bin;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eErase partition and copy the downloaded image\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eerase 0x9fEa0000 +0x140000;\ncp.b $fileaddr 0x9fea0000 $filesize;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eResult:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ear7240\u0026gt; setenv serverip 192.168.12.20;\nar7240\u0026gt; setenv ipaddr 192.168.12.201;\nar7240\u0026gt; tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-kernel.bin;\ndup 1 speed 100\nUsing eth0 device\nTFTP from server 192.168.12.20; our IP address is 192.168.12.201\nFilename \u0026#39;openwrt-ar71xx-generic-yun-16M-kernel.bin\u0026#39;.\nLoad address: 0x80060000\nLoading: #################################################################\n         #################################################################\n         #################################################################\n         #################################################\ndone\nBytes transferred = 1245184 (130000 hex)\nar7240\u0026gt; erase 0x9fEa0000 +0x140000;\nErase Flash from 0x9fea0000 to 0x9ffdffff in Bank # 1\nFirst 0xea last 0xfd sector size 0x10000                                     253\nErased 20 sectors\nar7240\u0026gt; cp.b $fileaddr 0x9fea0000 $filesize;\nCopy to Flash... write addr: 9fea0000\ndone\nar7240\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"reflashing-openwrt-yun\"\u003eReflashing OpenWrt-Yun\u003c/h4\u003e\n\u003c!-- 2017-01-27 12:31 CET --\u003e\n\n\u003cp\u003eDownload the file via FTP\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003etftp 0x80060000 openwrt-ar71xx-generic-yun-16M-rootfs-squashfs.bin;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eErase partition and copy the downloaded image\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eerase 0x9f050000 +0xE50000;\ncp.b $fileaddr 0x9f050000 $filesize;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eResult:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ear7240\u0026gt; tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-rootfs-squashfs.bin;\nUsing eth0 device\nTFTP from server 192.168.12.20; our IP address is 192.168.12.201\nFilename \u0026#39;openwrt-ar71xx-generic-yun-16M-rootfs-squashfs.bin\u0026#39;.\nLoad address: 0x80060000\nLoading: #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         ##########################################\ndone\nBytes transferred = 7864320 (780000 hex)\nar7240\u0026gt; erase 0x9f050000 +0xE50000;\nErase Flash from 0x9f050000 to 0x9fe9ffff in Bank # 1\nFirst 0x5 last 0xe9 sector size 0x10000                                      233\nErased 229 sectors\nar7240\u0026gt;  cp.b $fileaddr 0x9f050000 $filesize;\nCopy to Flash... write addr: 9f050000\ndone\nar7240\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"rebooting\"\u003eRebooting\u003c/h4\u003e\n\u003c!-- 2017-01-27 12:34 CET --\u003e\n\n\u003cpre\u003e\u003ccode\u003ebootm 0x9fea0000\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePress \u0026quot;Enter\u0026quot; for console login\u003c/p\u003e\n\u003cp\u003eResult:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e...\n[   40.550000] Linux video capture interface: v2.00\n[   40.670000] fuse init (API version 7.18)\n[   47.910000] eth1: link up (100Mbps/Full duplex)\n\n\n\nBusyBox v1.19.4 (2014-11-13 19:03:47 CET) built-in shell (ash)\nEnter \u0026#39;help\u0026#39; for a list of built-in commands.\n\n  _______                     ________        __\n |       |.-----.-----.-----.|  |  |  |.----.|  |_\n |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|\n |_______||   __|_____|__|__||________||__|  |____|\n          |__| W I R E L E S S   F R E E D O M\n -----------------------------------------------------\n\n\nroot@Arduino:/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eInspect filesystem usage after factory reflash\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@Arduino:/# df -h\nFilesystem                Size      Used Available Use% Mounted on\nrootfs                    6.9M    356.0K      6.6M   5% /\n/dev/root                 7.5M      7.5M         0 100% /rom\ntmpfs                    29.8M    100.0K     29.7M   0% /tmp\ntmpfs                   512.0K         0    512.0K   0% /dev\n/dev/mtdblock3            6.9M    356.0K      6.6M   5% /overlay\noverlayfs:/overlay        6.9M    356.0K      6.6M   5% /\nroot@Arduino:/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCheck \u003ccode\u003e/proc/cmdline\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@Arduino:/# cat /proc/cmdline\n board=Yun console=ttyATH0,250000 mtdparts=spi0.0:256k(u-boot)ro,64k(u-boot-env)ro,14656k(rootfs),1280k(kernel),64k(nvram),64k(art),15936k@0x50000(firmware) rootfstype=squashfs,jffs2 noinitrd\nroot@Arduino:/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCheck installed openwrt-yun-release\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@Arduino:~# cat /etc/arduino/openwrt-yun-release\nbuilt=Fri Nov 14 03:53:51 CET 2014\nroot@Arduino:~#\n\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch3 id=\"alternative-nuke-overlay\"\u003eAlternative: Nuke \u003ccode\u003e/overlay\u003c/code\u003e\u003c/h3\u003e\n\u003c!-- 2017-03-03 16:32 --\u003e\n\n\u003cp\u003eBoot \u003ccode\u003eardyungm33\u003c/code\u003e in failsafe mode by pressing the \u003ccode\u003eF\u003c/code\u003e and ENTER keys.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@(none):/# df -h\nFilesystem                Size      Used Available Use% Mounted on\nrootfs                    7.5M      7.5M         0 100% /\n/dev/root                 7.5M      7.5M         0 100% /\ntmpfs                    29.8M     12.0K     29.8M   0% /tmp\ntmpfs                   512.0K         0    512.0K   0% /dev\nroot@(none):/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eExecute \u003ccode\u003emount_root\u003c/code\u003e (checked from TODO to TODO)\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@(none):/# mount_root\n[  863.240000] JFFS2 notice: (533) jffs2_build_xattr_subsystem: complete building xattr subsystem, 1 of xdatum (1 unchecked, 0 orphan) and 12 of xref (0 dead, 1 orphan) found.\nswitching to jffs2\nroot@(none):/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eApart the suspicious message, the \u003ccode\u003e/overlay\u003c/code\u003e is mounted\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@(none):/# df -h\nFilesystem                Size      Used Available Use% Mounted on\nrootfs                    6.9M      1.6M      5.3M  23% /\n/dev/root                 7.5M      7.5M         0 100% /rom\ntmpfs                    29.8M     12.0K     29.8M   0% /tmp\ntmpfs                   512.0K         0    512.0K   0% /dev\n/dev/mtdblock3            6.9M      1.6M      5.3M  23% /overlay\noverlayfs:/overlay        6.9M      1.6M      5.3M  23% /\nroot@(none):/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePress \u0026quot;YUN RST\u0026quot; button, then enter failsafe mode.\u003c/p\u003e\n\u003cp\u003eUnderstand the \u003ccode\u003e/sbin/firstboot\u003c/code\u003e script:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@(none):/# which firstboot\n/sbin/firstboot\nroot@(none):/# cat /sbin/firstboot\n#!/bin/sh\n\nswitch2jffs_hook=\njffs2reset_hook=\nno_fo_hook=\n\n. /lib/functions/boot.sh\n\nfirstboot_skip_next=false\n\nfor fb_source_file in /lib/firstboot/*; do\n    . $fb_source_file\ndone\n\nset_mtd_part\nset_rom_part\nset_jffs_part\n\n# invoked as an executable\nif [ \u0026quot;${0##*/}\u0026quot; = \u0026quot;firstboot\u0026quot; ]; then\n    if [ \u0026quot;$1\u0026quot; = \u0026quot;switch2jffs\u0026quot; ]; then\n        boot_run_hook switch2jffs\n    elif [ -n \u0026quot;$jffs\u0026quot; ]; then\n        reset_has_fo=true\n        echo \u0026quot;firstboot has already been run\u0026quot;\n        echo \u0026quot;jffs2 partition is mounted, only resetting files\u0026quot;\n        boot_run_hook jffs2reset\n    else\n        mtd erase \u0026quot;$partname\u0026quot;\n        mount \u0026quot;$mtdpart\u0026quot; /overlay -t jffs2\n        fopivot /overlay /rom 1\n    fi\nfi\n\nroot@(none):/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- 2017-03-03 16:39 CET --\u003e\n\n\u003cp\u003eExecute the \u003ccode\u003e/bin/firstboot\u003c/code\u003e script:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eroot@(none):/# /sbin/firstboot\n[  133.510000] JFFS2 notice: (533) jffs2_build_xattr_subsystem: complete building xattr subsystem, 0 of xdatum (0 unchecked, 0 orphan) and 0 of xref (0 dead, 0 orphan) found.\nroot@(none):/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e==\u0026gt; Much better now!!!\u003c/p\u003e\n\u003cp\u003ePress \u0026quot;RST YUN\u0026quot; then boot to regular mode (do not press \u0026quot;F\u0026quot;)\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[   40.630000] fuse init (API version 7.18)\n\nPlease press Enter to activate this console.\n\n\nBusyBox v1.19.4 (2014-11-13 19:03:47 CET) built-in shell (ash)\nEnter \u0026#39;help\u0026#39; for a list of built-in commands.\n\n  _______                     ________        __\n |       |.-----.-----.-----.|  |  |  |.----.|  |_\n |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|\n |_______||   __|_____|__|__||________||__|  |____|\n          |__| W I R E L E S S   F R E E D O M\n -----------------------------------------------------\n\n\nroot@Arduino:/#\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- markdown-link-check-enable --\u003e\n\u003c!-- EOF --\u003e\n"},"config":{"title":"gmacario.github.io","description":"Gianpaolo Macario's public rants","social":{"github":{"name":"gmacario","link":"https://github.com/gmacario"},"twitter":{"name":"gpmacario","link":"https://www.twitter.com/gpmacario"}}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2017-03-03-restoring-arduino-yun-factory-settings"},"buildId":"RcQQcL0u_EYbVwrUiS1Y0","runtimeConfig":{},"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-144e5fa6fafab6397d9c.js"></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.1a5e6c0bcaecf178eee2.js" async=""></script><script src="/_next/static/chunks/commons.a817edd9b2693fcc6af8.js" async=""></script><script src="/_next/static/chunks/main-daaff4f95c13923f49a5.js" async=""></script><script src="/_next/static/chunks/pages/_app-2c0be973e770f89815b4.js" async=""></script><script src="/_next/static/chunks/b38cc82cec06c0ea8b096def674947a423bb2764.260eb1ac110a53311620.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-1c9a30b06d2f3be2ac9c.js" async=""></script><script src="/_next/static/RcQQcL0u_EYbVwrUiS1Y0/_buildManifest.js" async=""></script><script src="/_next/static/RcQQcL0u_EYbVwrUiS1Y0/_ssgManifest.js" async=""></script></body></html>