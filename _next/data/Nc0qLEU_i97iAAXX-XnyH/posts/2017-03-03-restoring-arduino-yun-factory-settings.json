{"pageProps":{"post":{"title":"Restoring Arduino Yun factory settings","content":"<!-- markdown-link-check-disable -->\n\n<h3 id=\"the-problem\">The problem</h3>\n<p>After a few months of uninterrupted service, my <a href=\"https://www.arduino.cc/en/Main/ArduinoBoardYun\">Arduino Yun</a> started rebooting every couple of minutes.</p>\n<p>Debugging by connecting the Arduino Yun to my laptop via USB cable.</p>\n<p>Run a terminal emulator (i.e. PuTTY) COMx:57600,8,n,1</p>\n<p>Login as <code>root</code></p>\n<pre><code>root@ardyungm33:/# mount\nrootfs on / type rootfs (rw)\n/dev/root on /rom type squashfs (ro,relatime)\nproc on /proc type proc (rw,noatime)\nsysfs on /sys type sysfs (rw,noatime)\ntmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime,size=30560k)\ntmpfs on /dev type tmpfs (rw,noatime,size=512k,mode=755)\ndevpts on /dev/pts type devpts (rw,noatime,mode=600)\n/dev/mtdblock3 on /overlay type jffs2 (rw,noatime)\noverlayfs:/overlay on / type overlayfs (rw,relatime,lowerdir=/,upperdir=/overlay)\ndebugfs on /sys/kernel/debug type debugfs (rw,relatime)\nroot@ardyungm33:/#\n</code></pre>\n<p><code>/dev/mtd3</code> is the raw image of overlay</p>\n<pre><code>root@ardyungm33:/# cat /proc/mtd\ndev:    size   erasesize  name\nmtd0: 00040000 00010000 &quot;u-boot&quot;\nmtd1: 00010000 00010000 &quot;u-boot-env&quot;\nmtd2: 00e50000 00010000 &quot;rootfs&quot;\nmtd3: 006f0000 00010000 &quot;rootfs_data&quot;\nmtd4: 00140000 00010000 &quot;kernel&quot;\nmtd5: 00010000 00010000 &quot;nvram&quot;\nmtd6: 00010000 00010000 &quot;art&quot;\nmtd7: 00f90000 00010000 &quot;firmware&quot;\nroot@ardyungm33:/#\n</code></pre>\n<p>After less than one minute from boot the board will restart - most likely because r/w overlay at <code>/dev/mtd3block</code> (rootfs_data) is corrupted.</p>\n<pre><code>root@ardyungm33:/#\nroot@ardyungm33:/# ping Jan 14 05:24:35 tinc.ninuxto[1107]: Got TERM signal\nJan 14 05:24:35 tinc.ninuxto[1107]: Terminating\n10[  129.650000] Removing MTD device #3 (rootfs_data) with use count 1\n[  129.670000] Res▒\n\nU-Boot 1.1.4-dirty (Apr 10 2014 - 15:12:15)\n\nArduino Yun (ar9331) U-boot\n...\n</code></pre>\n<p>Notice the error message <code>  129.650000] Removing MTD device #3 (rootfs_data) with use count 1</code></p>\n<h3 id=\"try-failsafe-mode\">Try Failsafe mode</h3>\n<p>Just after the Yun reboots, press <code>ENTER</code> to stop at U-boot prompt.</p>\n<pre><code>root@ardyungm33:/#\nroot@ardyungm33:/# ping Jan 14 05:24:35 tinc.ninuxto[1107]: Got TERM signal\nJan 14 05:24:35 tinc.ninuxto[1107]: Terminating\n10[  129.650000] Removing MTD device #3 (rootfs_data) with use count 1\n[  129.670000] Res▒\n\nU-Boot 1.1.4-dirty (Apr 10 2014 - 15:12:15)\n\nArduino Yun (ar9331) U-boot\n\nDRAM:  64 MB\nTop of RAM usable for U-Boot at: 84000000\nReserving 142k for U-Boot at: 83fdc000\nReserving 192k for malloc() at: 83fac000\nReserving 44 Bytes for Board Info at: 83fabfd4\nReserving 36 Bytes for Global Data at: 83fabfb0\nReserving 128k for boot params() at: 83f8bfb0\nStack Pointer at: 83f8bf98\nNow running in RAM - U-Boot at: 83fdc000\nFlash Manuf Id 0xef, DeviceId0 0x40, DeviceId1 0x18\nflash size 16777216, sector count = 256\nFlash: 16 MB\nUsing default environment\n\nIn:    serial\nOut:   serial\nErr:   serial\nNet:   ag7240_enet_initialize...\nNo valid address in Flash. Using fixed address\nNo valid address in Flash. Using fixed address\n: cfg1 0x5 cfg2 0x7114\neth0: 00:03:7f:09:0b:ad\neth0 up\n: cfg1 0xf cfg2 0x7214\neth1: 00:03:7f:09:0b:ad\nathrs26_reg_init_lan\nATHRS26: resetting s26\nATHRS26: s26 reset done\neth1 up\neth0, eth1\nHit any key to stop autoboot:  0\nar7240&gt;\n</code></pre>\n<p>Type <code>boot</code> to boot Linux, then press <code>F</code> to enter failsafe mode</p>\n<pre><code>ar7240&gt;\nar7240&gt; boot\n## Booting image at 9fea0000 ...\n   Image Name:   MIPS OpenWrt Linux-3.3.8\n   Created:      2014-11-14   8:00:46 UTC\n   Image Type:   MIPS Linux Kernel Image (lzma compressed)\n   Data Size:    1185448 Bytes =  1.1 MB\n   Load Address: 80060000\n   Entry Point:  80060000\n   Verifying Checksum at 0x9fea0040 ...OK\n   Uncompressing Kernel Image ...\n...\n[    4.240000] scsi0 : usb-storage 1-1.4:1.0\n[    5.020000] Error: Driver &#39;gpio-keys-polled&#39; is already registered, aborting...\n[    5.240000] scsi 0:0:0:0: Direct-Access     Multi    Flash Reader     1.00 PQ: 0 ANSI: 0\n- preinit -\nPress the [f] key and hit [enter] to enter failsafe mode\nf\n- failsafe -\n/etc/preinit: line 1: telnetd: not found\n\n\nBusyBox v1.19.4 (2014-11-13 19:03:47 CET) built-in shell (ash)\nEnter &#39;help&#39; for a list of built-in commands.\n\n  _______                     ________        __\n |       |.-----.-----.-----.|  |  |  |.----.|  |_\n |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|\n |_______||   __|_____|__|__||________||__|  |____|\n          |__| W I R E L E S S   F R E E D O M\n-----------------------------------------------------\n\n\nroot@(none):/#\n</code></pre>\n<p>Inspect MTD partitions</p>\n<pre><code>root@(none):/# cat /proc/mtd\ndev:    size   erasesize  name\nmtd0: 00040000 00010000 &quot;u-boot&quot;\nmtd1: 00010000 00010000 &quot;u-boot-env&quot;\nmtd2: 00e50000 00010000 &quot;rootfs&quot;\nmtd3: 006f0000 00010000 &quot;rootfs_data&quot;\nmtd4: 00140000 00010000 &quot;kernel&quot;\nmtd5: 00010000 00010000 &quot;nvram&quot;\nmtd6: 00010000 00010000 &quot;art&quot;\nmtd7: 00f90000 00010000 &quot;firmware&quot;\nroot@(none):/#\n</code></pre>\n<p>Inspect mounted filesystems</p>\n<pre><code>root@(none):/# mount\nrootfs on / type rootfs (rw)\n/dev/root on / type squashfs (ro,relatime)\nproc on /proc type proc (rw,noatime)\nsysfs on /sys type sysfs (rw,noatime)\ntmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime,size=30560k)\ntmpfs on /dev type tmpfs (rw,noatime,size=512k,mode=755)\ndevpts on /dev/pts type devpts (rw,noatime,mode=600)\nroot@(none):/#\n</code></pre>\n<p>OK, overlayfs was not mounted.</p>\n<h3 id=\"try-zeroing-devmtd3\">Try zeroing <code>/dev/mtd3</code></h3>\n<!-- 2017-01-26 19:03 CET -->\n\n<p>We are then safe to erase <code>/dev/mtd3</code></p>\n<pre><code>root@(none):/# dd if=/dev/zero of=/dev/mtd3\nroot@(none):/#\n</code></pre>\n<p>Now exit and cycle power (must disconnect and reconnect USB cable)</p>\n<pre><code>root@(none):/# exit\nPlease reboot system when done with failsafe network logins\n</code></pre>\n<h3 id=\"retry-boot-after-zeroing-devmtd3\">Retry boot after zeroing <code>/dev/mtd3</code></h3>\n<pre><code>...\n[    4.240000] scsi0 : usb-storage 1-1.4:1.0\n[    5.030000] Error: Driver &#39;gpio-keys-polled&#39; is already registered, aborting...\n[    5.240000] scsi 0:0:0:0: Direct-Access     Multi    Flash Reader     1.00 PQ: 0 ANSI: 0\n- preinit -\nPress the [f] key and hit [enter] to enter failsafe mode\n- regular preinit -\n[   13.200000] Cowardly refusing to erase blocks on filesystem with no valid JFFS2 nodes\n[   13.200000] empty_blocks 0, bad_blocks 0, c-&gt;nr_blocks 111\n[   14.380000] sd 0:0:0:0: [sda] Attached SCSI removable disk\nswitching to jffs2\n- init -\n[   41.710000] Loading modules backported from Linux version master-2014-05-22-0-gf2032ea\n...\n</code></pre>\n<p>TODO: Not sure whether zeroing <code>/dev/mtd3</code> is enough - need to look inside factory image (to be loaded via TFTP)</p>\n<p>Notice that failsafe mode still works, though.</p>\n<p>TODO: Understand how to properly format a JFFS2 partitions.</p>\n<p>TODO: Read <a href=\"http://free-electrons.com/blog/managing-flash-storage-with-linux/\">http://free-electrons.com/blog/managing-flash-storage-with-linux/</a></p>\n<pre><code>[    4.240000] scsi0 : usb-storage 1-1.4:1.0\n[    5.030000] Error: Driver &#39;gpio-keys-polled&#39; is already registered, aborting...\n[    5.240000] scsi 0:0:0:0: Direct-Access     Multi    Flash Reader     1.00 PQ: 0 ANSI: 0\n- preinit -\nPress the [f] key and hit [enter] to enter failsafe mode\n- regular preinit -\n[   13.210000] Cowardly refusing to erase blocks on filesystem with no valid JFFS2 nodes\n[   13.210000] empty_blocks 0, bad_blocks 0, c-&gt;nr_blocks 111\n[   14.390000] sd 0:0:0:0: [sda] Attached SCSI removable disk\n</code></pre>\n<h3 id=\"reflash-the-openwrt-yun-image-on-the-yun\">Reflash the OpenWrt-Yun image on the Yun</h3>\n<!-- 2017-01-27 13:00 CET -->\n\n<p>Follow instructions at <a href=\"https://www.arduino.cc/en/Tutorial/YunUBootReflash\">https://www.arduino.cc/en/Tutorial/YunUBootReflash</a></p>\n<p>This procedure uses U-Boot to load kernel and openwrt-rootfs via TFTP</p>\n<p>Download the <a href=\"http://arduino.cc/download_handler.php?f=/openwrtyun/1/YunImage_v1.5.3.zip\">base images</a> zip file.</p>\n<p>Setup a TFTP server on kruk (Ubuntu 16.04 LTS)</p>\n<p>Logged as user@kruk</p>\n<pre><code>sudo apt update\nsudo apt install tftpd-hpa\n</code></pre>\n<p>When asked for the directory to use as root for the TFTP server, leave the default value <code>/var/lib/tftpboot</code>.</p>\n<p>Unzip <code>~/Downloads/YunImage_v1.5.3.zip</code> into folder <code>/var/lib/tftpboot</code>:</p>\n<pre><code>cd /var/lib/tftpboot\nsudo unzip ~/Downloads/YunImage_v1.5.3.zip\n</code></pre>\n<p>Power up the Yun and type a key to stop at the U-Boot prompt.</p>\n<p>At the U-Boot prompt</p>\n<pre><code>setenv serverip 192.168.12.20;\nsetenv ipaddr 192.168.12.201;\n</code></pre>\n<h4 id=\"reflashing-kernel\">Reflashing Kernel</h4>\n<!-- 2017-01-27 12:24 CET -->\n\n<p>Download the file via FTP</p>\n<pre><code>tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-kernel.bin;\n</code></pre>\n<p>Erase partition and copy the downloaded image</p>\n<pre><code>erase 0x9fEa0000 +0x140000;\ncp.b $fileaddr 0x9fea0000 $filesize;\n</code></pre>\n<p>Result:</p>\n<pre><code>ar7240&gt; setenv serverip 192.168.12.20;\nar7240&gt; setenv ipaddr 192.168.12.201;\nar7240&gt; tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-kernel.bin;\ndup 1 speed 100\nUsing eth0 device\nTFTP from server 192.168.12.20; our IP address is 192.168.12.201\nFilename &#39;openwrt-ar71xx-generic-yun-16M-kernel.bin&#39;.\nLoad address: 0x80060000\nLoading: #################################################################\n         #################################################################\n         #################################################################\n         #################################################\ndone\nBytes transferred = 1245184 (130000 hex)\nar7240&gt; erase 0x9fEa0000 +0x140000;\nErase Flash from 0x9fea0000 to 0x9ffdffff in Bank # 1\nFirst 0xea last 0xfd sector size 0x10000                                     253\nErased 20 sectors\nar7240&gt; cp.b $fileaddr 0x9fea0000 $filesize;\nCopy to Flash... write addr: 9fea0000\ndone\nar7240&gt;\n</code></pre>\n<h4 id=\"reflashing-openwrt-yun\">Reflashing OpenWrt-Yun</h4>\n<!-- 2017-01-27 12:31 CET -->\n\n<p>Download the file via FTP</p>\n<pre><code>tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-rootfs-squashfs.bin;\n</code></pre>\n<p>Erase partition and copy the downloaded image</p>\n<pre><code>erase 0x9f050000 +0xE50000;\ncp.b $fileaddr 0x9f050000 $filesize;\n</code></pre>\n<p>Result:</p>\n<pre><code>ar7240&gt; tftp 0x80060000 openwrt-ar71xx-generic-yun-16M-rootfs-squashfs.bin;\nUsing eth0 device\nTFTP from server 192.168.12.20; our IP address is 192.168.12.201\nFilename &#39;openwrt-ar71xx-generic-yun-16M-rootfs-squashfs.bin&#39;.\nLoad address: 0x80060000\nLoading: #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         #################################################################\n         ##########################################\ndone\nBytes transferred = 7864320 (780000 hex)\nar7240&gt; erase 0x9f050000 +0xE50000;\nErase Flash from 0x9f050000 to 0x9fe9ffff in Bank # 1\nFirst 0x5 last 0xe9 sector size 0x10000                                      233\nErased 229 sectors\nar7240&gt;  cp.b $fileaddr 0x9f050000 $filesize;\nCopy to Flash... write addr: 9f050000\ndone\nar7240&gt;\n</code></pre>\n<h4 id=\"rebooting\">Rebooting</h4>\n<!-- 2017-01-27 12:34 CET -->\n\n<pre><code>bootm 0x9fea0000\n</code></pre>\n<p>Press &quot;Enter&quot; for console login</p>\n<p>Result:</p>\n<pre><code>...\n[   40.550000] Linux video capture interface: v2.00\n[   40.670000] fuse init (API version 7.18)\n[   47.910000] eth1: link up (100Mbps/Full duplex)\n\n\n\nBusyBox v1.19.4 (2014-11-13 19:03:47 CET) built-in shell (ash)\nEnter &#39;help&#39; for a list of built-in commands.\n\n  _______                     ________        __\n |       |.-----.-----.-----.|  |  |  |.----.|  |_\n |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|\n |_______||   __|_____|__|__||________||__|  |____|\n          |__| W I R E L E S S   F R E E D O M\n -----------------------------------------------------\n\n\nroot@Arduino:/#\n</code></pre>\n<p>Inspect filesystem usage after factory reflash</p>\n<pre><code>root@Arduino:/# df -h\nFilesystem                Size      Used Available Use% Mounted on\nrootfs                    6.9M    356.0K      6.6M   5% /\n/dev/root                 7.5M      7.5M         0 100% /rom\ntmpfs                    29.8M    100.0K     29.7M   0% /tmp\ntmpfs                   512.0K         0    512.0K   0% /dev\n/dev/mtdblock3            6.9M    356.0K      6.6M   5% /overlay\noverlayfs:/overlay        6.9M    356.0K      6.6M   5% /\nroot@Arduino:/#\n</code></pre>\n<p>Check <code>/proc/cmdline</code></p>\n<pre><code>root@Arduino:/# cat /proc/cmdline\n board=Yun console=ttyATH0,250000 mtdparts=spi0.0:256k(u-boot)ro,64k(u-boot-env)ro,14656k(rootfs),1280k(kernel),64k(nvram),64k(art),15936k@0x50000(firmware) rootfstype=squashfs,jffs2 noinitrd\nroot@Arduino:/#\n</code></pre>\n<p>Check installed openwrt-yun-release</p>\n<pre><code>root@Arduino:~# cat /etc/arduino/openwrt-yun-release\nbuilt=Fri Nov 14 03:53:51 CET 2014\nroot@Arduino:~#\n</code></pre>\n<hr>\n<h3 id=\"alternative-nuke-overlay\">Alternative: Nuke <code>/overlay</code></h3>\n<!-- 2017-03-03 16:32 -->\n\n<p>Boot <code>ardyungm33</code> in failsafe mode by pressing the <code>F</code> and ENTER keys.</p>\n<pre><code>root@(none):/# df -h\nFilesystem                Size      Used Available Use% Mounted on\nrootfs                    7.5M      7.5M         0 100% /\n/dev/root                 7.5M      7.5M         0 100% /\ntmpfs                    29.8M     12.0K     29.8M   0% /tmp\ntmpfs                   512.0K         0    512.0K   0% /dev\nroot@(none):/#\n</code></pre>\n<p>Execute <code>mount_root</code> (checked from TODO to TODO)</p>\n<pre><code>root@(none):/# mount_root\n[  863.240000] JFFS2 notice: (533) jffs2_build_xattr_subsystem: complete building xattr subsystem, 1 of xdatum (1 unchecked, 0 orphan) and 12 of xref (0 dead, 1 orphan) found.\nswitching to jffs2\nroot@(none):/#\n</code></pre>\n<p>Apart the suspicious message, the <code>/overlay</code> is mounted</p>\n<pre><code>root@(none):/# df -h\nFilesystem                Size      Used Available Use% Mounted on\nrootfs                    6.9M      1.6M      5.3M  23% /\n/dev/root                 7.5M      7.5M         0 100% /rom\ntmpfs                    29.8M     12.0K     29.8M   0% /tmp\ntmpfs                   512.0K         0    512.0K   0% /dev\n/dev/mtdblock3            6.9M      1.6M      5.3M  23% /overlay\noverlayfs:/overlay        6.9M      1.6M      5.3M  23% /\nroot@(none):/#\n</code></pre>\n<p>Press &quot;YUN RST&quot; button, then enter failsafe mode.</p>\n<p>Understand the <code>/sbin/firstboot</code> script:</p>\n<pre><code>root@(none):/# which firstboot\n/sbin/firstboot\nroot@(none):/# cat /sbin/firstboot\n#!/bin/sh\n\nswitch2jffs_hook=\njffs2reset_hook=\nno_fo_hook=\n\n. /lib/functions/boot.sh\n\nfirstboot_skip_next=false\n\nfor fb_source_file in /lib/firstboot/*; do\n    . $fb_source_file\ndone\n\nset_mtd_part\nset_rom_part\nset_jffs_part\n\n# invoked as an executable\nif [ &quot;${0##*/}&quot; = &quot;firstboot&quot; ]; then\n    if [ &quot;$1&quot; = &quot;switch2jffs&quot; ]; then\n        boot_run_hook switch2jffs\n    elif [ -n &quot;$jffs&quot; ]; then\n        reset_has_fo=true\n        echo &quot;firstboot has already been run&quot;\n        echo &quot;jffs2 partition is mounted, only resetting files&quot;\n        boot_run_hook jffs2reset\n    else\n        mtd erase &quot;$partname&quot;\n        mount &quot;$mtdpart&quot; /overlay -t jffs2\n        fopivot /overlay /rom 1\n    fi\nfi\n\nroot@(none):/#\n</code></pre>\n<!-- 2017-03-03 16:39 CET -->\n\n<p>Execute the <code>/bin/firstboot</code> script:</p>\n<pre><code>root@(none):/# /sbin/firstboot\n[  133.510000] JFFS2 notice: (533) jffs2_build_xattr_subsystem: complete building xattr subsystem, 0 of xdatum (0 unchecked, 0 orphan) and 0 of xref (0 dead, 0 orphan) found.\nroot@(none):/#\n</code></pre>\n<p>==&gt; Much better now!!!</p>\n<p>Press &quot;RST YUN&quot; then boot to regular mode (do not press &quot;F&quot;)</p>\n<pre><code>[   40.630000] fuse init (API version 7.18)\n\nPlease press Enter to activate this console.\n\n\nBusyBox v1.19.4 (2014-11-13 19:03:47 CET) built-in shell (ash)\nEnter &#39;help&#39; for a list of built-in commands.\n\n  _______                     ________        __\n |       |.-----.-----.-----.|  |  |  |.----.|  |_\n |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|\n |_______||   __|_____|__|__||________||__|  |____|\n          |__| W I R E L E S S   F R E E D O M\n -----------------------------------------------------\n\n\nroot@Arduino:/#\n</code></pre>\n<!-- markdown-link-check-enable -->\n<!-- EOF -->\n"},"config":{"title":"gmacario.github.io","description":"Gianpaolo Macario's public rants","social":{"github":{"name":"gmacario","link":"https://github.com/gmacario"},"twitter":{"name":"gpmacario","link":"https://www.twitter.com/gpmacario"}}}},"__N_SSG":true}